<!-- 
  @Author: Andreas Paepcke
  @Date:   2025-11-28 12:03:58
  @Last Modified by:   Andreas Paepcke
  @Last Modified time: 2025-11-28 12:44:14
-->
{% extends "base.html" %}

{% block title %}{{ photo.file_name }} - Photo Detail{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-3">
        <button onclick="window.location.href='{{ url_for('index') }}'" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Search
        </button>
        <a href="/?similar={{ photo.guid }}" class="btn btn-primary ms-2" onclick="findSimilarFromDetail('{{ photo.guid }}', event)">
            <i class="bi bi-images"></i> Find Similar Photos
        </a>
        <button class="btn btn-danger ms-2" onclick="showDeleteModal()">
            <i class="bi bi-trash"></i> Delete
        </button>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Delete Photo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Are you sure you want to delete this photo?</strong></p>
                
                <div class="alert alert-warning">
                    <strong>File:</strong> {{ photo.file_name }}<br>
                    <strong>Path:</strong> {{ photo.file_path }}
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="deleteFileCheck">
                    <label class="form-check-label" for="deleteFileCheck">
                        <strong>Also delete file from disk</strong>
                        <br>
                        <small class="text-muted">
                            ⚠️ Warning: This will permanently delete the file from your computer.
                            By default, the photo is only removed from the index.
                        </small>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Photo Display -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div id="photoContainer" style="position: relative; background: #000;">
                <img id="photoImage"
                     src="{{ url_for('serve_photo', guid=photo.guid) }}"
                     class="card-img-top"
                     alt="{{ photo.file_name }}"
                     style="max-height: 70vh; object-fit: contain; width: 100%; display: block;">
                <canvas id="faceOverlay"
                        style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
            </div>
            <div class="card-body">
                <h5 class="card-title">{{ photo.file_name }}</h5>
                <p class="text-muted">{{ photo.file_path }}</p>
            </div>
        </div>
    </div>

    <!-- Metadata Sidebar -->
    <div class="col-lg-4">
        <!-- Description -->
        {% if photo.description_parsed %}
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-tags"></i> Description
            </div>
            <div class="card-body">
                {% if photo.description_parsed.objects %}
                <h6>Objects</h6>
                <p>
                    {% for obj in photo.description_parsed.objects %}
                    <span class="badge bg-secondary">{{ obj }}</span>
                    {% endfor %}
                </p>
                {% endif %}

                {% if photo.description_parsed.materials %}
                <h6>Materials</h6>
                <p>
                    {% for mat in photo.description_parsed.materials %}
                    <span class="badge bg-info">{{ mat }}</span>
                    {% endfor %}
                </p>
                {% endif %}

                {% if photo.description_parsed.setting %}
                <h6>Setting</h6>
                <p>
                    {% for set in photo.description_parsed.setting %}
                    <span class="badge bg-success">{{ set }}</span>
                    {% endfor %}
                </p>
                {% endif %}

                {% if photo.description_parsed.visual_attributes %}
                <h6>Visual Attributes</h6>
                <p>
                    {% for attr in photo.description_parsed.visual_attributes %}
                    <span class="badge bg-warning text-dark">{{ attr }}</span>
                    {% endfor %}
                </p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Faces -->
        {% if photo.face_count and photo.face_count > 0 %}
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <i class="bi bi-person-circle"></i> Detected Faces ({{ photo.face_count }})
            </div>
            <div class="card-body">
                <div id="facesContainer">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Loading faces...</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Keywords -->
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-tags-fill"></i> Keywords
            </div>
            <div class="card-body">
                <!-- AI Keywords (Read-only) -->
                {% if photo.ai_keywords %}
                <div class="mb-3">
                    <h6>AI-Generated Tags</h6>
                    <p>
                        {% for keyword in photo.ai_keywords %}
                        <span class="badge bg-secondary">{{ keyword }}</span>
                        {% endfor %}
                    </p>
                </div>
                {% endif %}

                <!-- User Keywords (Editable) -->
                <div>
                    <h6>Your Tags</h6>
                    <div id="userKeywordsDisplay" class="mb-2">
                        {% if photo.user_keywords %}
                            {% for keyword in photo.user_keywords %}
                            <span class="badge bg-primary">{{ keyword }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">No tags yet</span>
                        {% endif %}
                    </div>

                    <div class="input-group mb-2">
                        <input type="text"
                               id="keywordInput"
                               class="form-control form-control-sm"
                               placeholder="Add tags (comma-separated)"
                               value="{{ photo.user_keywords|join(', ') if photo.user_keywords else '' }}">
                        <button class="btn btn-sm btn-primary" onclick="saveKeywords()">
                            <i class="bi bi-save"></i> Save
                        </button>
                    </div>
                    <small class="text-muted">
                        Tags are saved to the photo's EXIF metadata and searchable.
                    </small>
                </div>
            </div>
        </div>

        <!-- EXIF Data -->
        {% if photo.exif %}
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <i class="bi bi-camera"></i> Camera & Settings
            </div>
            <div class="card-body">
                {% if photo.exif.camera_make %}
                <p><strong>Camera:</strong> {{ photo.exif.camera_make }} {{ photo.exif.camera_model }}</p>
                {% endif %}
                
                {% if photo.exif.date_taken %}
                <p><strong>Date:</strong> {{ photo.exif.date_taken }}</p>
                {% endif %}

                {% if photo.exif.width and photo.exif.height %}
                <p><strong>Size:</strong> {{ photo.exif.width }} × {{ photo.exif.height }}</p>
                {% endif %}

                {% if photo.exif.iso %}
                <p><strong>ISO:</strong> {{ photo.exif.iso }}</p>
                {% endif %}

                {% if photo.exif.focal_length %}
                <p><strong>Focal Length:</strong> {{ photo.exif.focal_length }}mm</p>
                {% endif %}

                {% if photo.exif.aperture %}
                <p><strong>Aperture:</strong> f/{{ photo.exif.aperture }}</p>
                {% endif %}

                {% if photo.exif.exposure_time %}
                <p><strong>Exposure:</strong> {{ photo.exif.exposure_time }}s</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Location -->
        {% if photo.location or photo.gps %}
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <i class="bi bi-geo-alt"></i> Location
            </div>
            <div class="card-body">
                {% if photo.location %}
                    <p><strong>Address:</strong><br>{{ photo.location.formatted_address or 'Unknown' }}</p>
                    
                    {% if photo.location.city %}
                    <p><strong>City:</strong> {{ photo.location.city }}</p>
                    {% endif %}
                    
                    {% if photo.location.state %}
                    <p><strong>State:</strong> {{ photo.location.state }}</p>
                    {% endif %}
                    
                    {% if photo.location.country %}
                    <p><strong>Country:</strong> {{ photo.location.country }}</p>
                    {% endif %}
                {% endif %}

                {% if photo.gps and photo.gps.latitude %}
                <p>
                    <strong>GPS:</strong><br>
                    {{ "%.6f"|format(photo.gps.latitude) }}, {{ "%.6f"|format(photo.gps.longitude) }}
                    <br>
                    <a href="https://www.google.com/maps?q={{ photo.gps.latitude }},{{ photo.gps.longitude }}" 
                       target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                        <i class="bi bi-map"></i> View on Map
                    </a>
                </p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- File Info -->
        <div class="card mb-3">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-file-earmark"></i> File Info
            </div>
            <div class="card-body">
                <p><strong>GUID:</strong><br><code>{{ photo.guid }}</code></p>
                <p><strong>Size:</strong> {{ (photo.file_size / 1024 / 1024)|round(2) }} MB</p>
                <p><strong>Indexed:</strong> {{ photo.indexed_at }}</p>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
const photoGuid = '{{ photo.guid }}';
const photoFileName = '{{ photo.file_name }}';
const hasFaces = {{ 'true' if photo.face_count and photo.face_count > 0 else 'false' }};

// Store face data globally
let allFaces = [];
let canvas = null;
let ctx = null;
let photoImage = null;

function showDeleteModal() {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Load faces on page load
if (hasFaces) {
    document.addEventListener('DOMContentLoaded', () => {
        loadFaces();
        initializeCanvas();
    });
}

function initializeCanvas() {
    canvas = document.getElementById('faceOverlay');
    ctx = canvas.getContext('2d');
    photoImage = document.getElementById('photoImage');

    // Resize canvas to match image when it loads
    photoImage.addEventListener('load', resizeCanvas);
    window.addEventListener('resize', resizeCanvas);

    // Initial resize
    if (photoImage.complete) {
        resizeCanvas();
    }
}

function resizeCanvas() {
    if (!canvas || !photoImage) return;

    // Set canvas size to match the displayed image size
    canvas.width = photoImage.offsetWidth;
    canvas.height = photoImage.offsetHeight;
}

async function loadFaces() {
    try {
        const response = await fetch(`/photo/${photoGuid}/faces`);
        if (!response.ok) throw new Error('Failed to load faces');

        const data = await response.json();
        allFaces = data.faces;  // Store globally
        displayFaces(data.faces);
    } catch (error) {
        document.getElementById('facesContainer').innerHTML =
            '<div class="alert alert-danger">Error loading faces</div>';
    }
}

function displayFaces(faces) {
    const container = document.getElementById('facesContainer');

    if (faces.length === 0) {
        container.innerHTML = '<p class="text-muted">No faces detected</p>';
        return;
    }

    let html = '';
    faces.forEach((face, index) => {
        const personName = face.person_name || 'Unknown';
        const isTagged = face.person_name !== null;

        html += `
            <div class="face-item mb-3 pb-3 ${index < faces.length - 1 ? 'border-bottom' : ''}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong>Face ${face.face_index + 1}</strong>
                    <small class="text-muted">${(face.confidence * 100).toFixed(1)}% confidence</small>
                </div>

                <div class="mb-2">
                    <strong>Person:</strong>
                    <span id="personName_${face.face_index}" class="${isTagged ? 'text-success' : 'text-muted'}">
                        ${personName}
                    </span>
                </div>

                <div class="input-group input-group-sm">
                    <input type="text"
                           class="form-control face-name-input"
                           id="nameInput_${face.face_index}"
                           data-face-index="${face.face_index}"
                           placeholder="Enter person name"
                           value="${face.person_name || ''}">
                    <button class="btn btn-primary"
                            onclick="tagFace(${face.face_index})">
                        <i class="bi bi-tag"></i> Tag
                    </button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // Add focus/blur event handlers to all name inputs
    document.querySelectorAll('.face-name-input').forEach(input => {
        input.addEventListener('focus', function() {
            const faceIndex = parseInt(this.dataset.faceIndex);
            showFaceBoundingBox(faceIndex);
        });

        input.addEventListener('blur', function() {
            clearBoundingBox();
        });
    });
}

function showFaceBoundingBox(faceIndex) {
    if (!ctx || !canvas || !photoImage) return;

    // Find the face by index
    const face = allFaces.find(f => f.face_index === faceIndex);
    if (!face || !face.bbox) return;

    // Clear any existing box
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Get image natural and displayed dimensions
    const naturalWidth = photoImage.naturalWidth;
    const naturalHeight = photoImage.naturalHeight;
    const containerWidth = photoImage.offsetWidth;
    const containerHeight = photoImage.offsetHeight;

    // Calculate the actual displayed image dimensions and offset
    // (accounting for object-fit: contain letterboxing)
    const imageRatio = naturalWidth / naturalHeight;
    const containerRatio = containerWidth / containerHeight;

    let displayWidth, displayHeight, offsetX, offsetY;

    if (containerRatio > imageRatio) {
        // Container is wider - image has letterboxing on left/right
        displayHeight = containerHeight;
        displayWidth = naturalWidth * (containerHeight / naturalHeight);
        offsetX = (containerWidth - displayWidth) / 2;
        offsetY = 0;
    } else {
        // Container is taller - image has letterboxing on top/bottom
        displayWidth = containerWidth;
        displayHeight = naturalHeight * (containerWidth / naturalWidth);
        offsetX = 0;
        offsetY = (containerHeight - displayHeight) / 2;
    }

    // Calculate scale factors
    const scaleX = displayWidth / naturalWidth;
    const scaleY = displayHeight / naturalHeight;

    // bbox format: [x1, y1, x2, y2] - top-left and bottom-right corners
    const [x1, y1, x2, y2] = face.bbox;

    // Convert to x, y, width, height
    const x = x1;
    const y = y1;
    const width = x2 - x1;
    const height = y2 - y1;

    // Scale to displayed image size and add offset
    const scaledX = (x * scaleX) + offsetX;
    const scaledY = (y * scaleY) + offsetY;
    const scaledWidth = width * scaleX;
    const scaledHeight = height * scaleY;

    // Draw bounding box
    ctx.strokeStyle = '#00ff00';  // Green color
    ctx.lineWidth = 3;
    ctx.strokeRect(scaledX, scaledY, scaledWidth, scaledHeight);

    // Add label with face number
    ctx.fillStyle = '#00ff00';
    ctx.font = 'bold 16px Arial';
    const label = `Face ${faceIndex + 1}`;
    const labelWidth = ctx.measureText(label).width;

    // Draw label background
    ctx.fillStyle = 'rgba(0, 255, 0, 0.7)';
    ctx.fillRect(scaledX, scaledY - 25, labelWidth + 10, 20);

    // Draw label text
    ctx.fillStyle = '#000';
    ctx.fillText(label, scaledX + 5, scaledY - 10);
}

function clearBoundingBox() {
    if (!ctx || !canvas) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

async function tagFace(faceIndex) {
    const nameInput = document.getElementById(`nameInput_${faceIndex}`);
    const personName = nameInput.value.trim();

    if (!personName) {
        alert('Please enter a person name');
        return;
    }

    // Show loading
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
    loadingMsg.style.zIndex = '9999';
    loadingMsg.innerHTML = '<i class="bi bi-hourglass-split"></i> Tagging face...';
    document.body.appendChild(loadingMsg);

    try {
        const response = await fetch(`/photo/${photoGuid}/faces/${faceIndex}/tag`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                person_name: personName
            })
        });

        const data = await response.json();

        loadingMsg.remove();

        if (response.ok) {
            // Update display
            const personNameSpan = document.getElementById(`personName_${faceIndex}`);
            personNameSpan.textContent = personName;
            personNameSpan.className = 'text-success';

            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
            successMsg.style.zIndex = '9999';
            successMsg.innerHTML = `<i class="bi bi-check-circle"></i> Tagged as ${personName}`;
            document.body.appendChild(successMsg);

            setTimeout(() => successMsg.remove(), 2000);
        } else {
            alert(`Error: ${data.error || 'Failed to tag face'}`);
        }

    } catch (error) {
        loadingMsg.remove();
        alert(`Error: ${error.message}`);
    }
}

async function confirmDelete() {
    const deleteFileCheck = document.getElementById('deleteFileCheck');
    const deleteFile = deleteFileCheck.checked;
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
    modal.hide();
    
    // Show loading
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
    loadingMsg.style.zIndex = '9999';
    loadingMsg.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
    document.body.appendChild(loadingMsg);
    
    try {
        const response = await fetch(`/delete/${photoGuid}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                delete_file: deleteFile
            })
        });
        
        const data = await response.json();
        
        // Remove loading message
        loadingMsg.remove();
        
        if (response.ok) {
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
            successMsg.style.zIndex = '9999';
            successMsg.innerHTML = `
                <i class="bi bi-check-circle"></i> ${data.message}
                <br><small>Redirecting to search...</small>
            `;
            document.body.appendChild(successMsg);
            
            // Redirect to home after 2 seconds
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
            
        } else {
            // Show error
            alert(`Error: ${data.error || 'Failed to delete photo'}`);
        }
        
    } catch (error) {
        loadingMsg.remove();
        alert(`Error: ${error.message}`);
    }
}

function findSimilarFromDetail(guid, event) {
    event.preventDefault();
    // Navigate to home page and trigger search
    window.location.href = `/?findSimilar=${guid}`;
}

async function saveKeywords() {
    const input = document.getElementById('keywordInput');
    const keywords = input.value
        .split(',')
        .map(k => k.trim())
        .filter(k => k.length > 0);

    // Show loading
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
    loadingMsg.style.zIndex = '9999';
    loadingMsg.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving tags...';
    document.body.appendChild(loadingMsg);

    try {
        const response = await fetch(`/photo/${photoGuid}/keywords`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                keywords: keywords
            })
        });

        const data = await response.json();

        // Remove loading message
        loadingMsg.remove();

        if (response.ok) {
            // Update display
            const display = document.getElementById('userKeywordsDisplay');
            if (keywords.length > 0) {
                display.innerHTML = keywords.map(k =>
                    `<span class="badge bg-primary">${k}</span>`
                ).join(' ');
            } else {
                display.innerHTML = '<span class="text-muted">No tags yet</span>';
            }

            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
            successMsg.style.zIndex = '9999';
            successMsg.innerHTML = '<i class="bi bi-check-circle"></i> Tags saved!';
            document.body.appendChild(successMsg);

            setTimeout(() => successMsg.remove(), 2000);

        } else {
            alert(`Error: ${data.error || 'Failed to save tags'}`);
        }

    } catch (error) {
        loadingMsg.remove();
        alert(`Error: ${error.message}`);
    }
}
</script>
{% endblock %}
{% endblock %}
