<!-- 
  @Author: Andreas Paepcke
  @Date:   2025-11-27 11:13:55
  @Last Modified by:   Andreas Paepcke
  @Last Modified time: 2025-11-28 12:43:43
-->
{% extends "base.html" %}

{% block title %}Photo Search - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-search"></i> Search Your Photos
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Search Form -->
        <div class="search-section">
            <form id="searchForm" enctype="multipart/form-data">
                <!-- Search Type Tabs -->
                <ul class="nav nav-tabs mb-3" id="searchTypeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-search" type="button">
                            <i class="bi bi-fonts"></i> Text Search
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image-search" type="button">
                            <i class="bi bi-image"></i> Similar Images
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="hybrid-tab" data-bs-toggle="tab" data-bs-target="#hybrid-search" type="button">
                            <i class="bi bi-plus-circle"></i> Hybrid Search
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="searchTypeContent">
                    <!-- Text Search -->
                    <div class="tab-pane fade show active" id="text-search">
                        <input type="hidden" name="search_type" value="text">
                        <div class="mb-3">
                            <label for="textQuery" class="form-label">Search for:</label>
                            <input type="text" class="form-control form-control-lg" id="textQuery" name="text_query" 
                                   placeholder="e.g., dog, sunset, beach...">
                            <div class="form-text">Search in photo descriptions (objects, materials, setting, visual attributes)</div>
                        </div>
                    </div>

                    <!-- Image Search -->
                    <div class="tab-pane fade" id="image-search">
                        <input type="hidden" name="search_type" value="image">
                        <div class="mb-3">
                            <label for="queryImage" class="form-label">Upload a query image:</label>
                            <input type="file" class="form-control" id="queryImage" name="query_image" accept="image/*">
                            <div class="form-text">Find photos visually similar to this image</div>
                        </div>
                        <div class="mb-3">
                            <label for="scoreThreshold" class="form-label">Minimum Similarity (optional):</label>
                            <input type="number" class="form-control" id="scoreThreshold" name="score_threshold" 
                                   min="0" max="1" step="0.1" placeholder="0.0 - 1.0">
                        </div>
                    </div>

                    <!-- Hybrid Search -->
                    <div class="tab-pane fade" id="hybrid-search">
                        <input type="hidden" name="search_type" value="hybrid">
                        <div class="mb-3">
                            <label for="hybridImage" class="form-label">Query Image (optional):</label>
                            <input type="file" class="form-control" id="hybridImage" name="query_image" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="hybridText" class="form-label">Text Query (optional):</label>
                            <input type="text" class="form-control" id="hybridText" name="text_query" 
                                   placeholder="e.g., outdoor, sunset...">
                        </div>
                        <div class="mb-3">
                            <label for="hybridThreshold" class="form-label">Minimum Similarity (optional):</label>
                            <input type="number" class="form-control" id="hybridThreshold" name="score_threshold" 
                                   min="0" max="1" step="0.1" placeholder="0.0 - 1.0">
                        </div>
                    </div>
                </div>

                <!-- Filters (collapsible) -->
                <div class="mb-3">
                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                        <i class="bi bi-funnel"></i> Advanced Filters
                    </button>
                </div>

                <div class="collapse" id="filtersCollapse">
                    <div class="filter-section">
                        <div class="row">
                            <!-- Location Filters -->
                            <div class="col-md-4 mb-3">
                                <h6><i class="bi bi-geo-alt"></i> Location</h6>
                                <input type="text" class="form-control mb-2" name="location_city" placeholder="City">
                                <input type="text" class="form-control mb-2" name="location_state" placeholder="State">
                                <input type="text" class="form-control" name="location_country" placeholder="Country">
                            </div>

                            <!-- Date Filters -->
                            <div class="col-md-4 mb-3">
                                <h6><i class="bi bi-calendar"></i> Date Range</h6>
                                <input type="date" class="form-control mb-2" name="date_from" 
                                       placeholder="From (YYYY-MM-DD)" 
                                       min="2000-01-01" max="2099-12-31"
                                       title="Click or type date (YYYY-MM-DD)">
                                <input type="date" class="form-control" name="date_to" 
                                       placeholder="To (YYYY-MM-DD)"
                                       min="2000-01-01" max="2099-12-31"
                                       title="Click or type date (YYYY-MM-DD)">
                            </div>

                            <!-- Camera Filters -->
                            <div class="col-md-4 mb-3">
                                <h6><i class="bi bi-camera"></i> Camera</h6>
                                <input type="text" class="form-control mb-2" name="camera_make" placeholder="Make (e.g., Canon)">
                                <input type="text" class="form-control" name="camera_model" placeholder="Model (e.g., EOS R5)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Limit -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="limit" class="form-label">Results:</label>
                        <select class="form-select" id="limit" name="limit">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>

                <!-- Submit -->
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-search"></i> Search
                </button>
                <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="clearSearch()">
                    <i class="bi bi-x-circle"></i> Clear Search
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 id="resultsTitle">Results</h2>
                <button class="btn btn-secondary" onclick="clearResults()">
                    <i class="bi bi-x-circle"></i> Clear
                </button>
            </div>
            
            <div class="photo-grid" id="resultsGrid"></div>
        </div>

        <!-- No Results -->
        <div id="noResults" style="display: none;">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No photos found matching your search criteria.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const searchForm = document.getElementById('searchForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const resultsSection = document.getElementById('resultsSection');
    const resultsGrid = document.getElementById('resultsGrid');
    const resultsTitle = document.getElementById('resultsTitle');
    const noResults = document.getElementById('noResults');

    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Save search state to sessionStorage
        saveSearchState();

        // Show loading
        loadingOverlay.classList.add('active');
        resultsSection.style.display = 'none';
        noResults.style.display = 'none';

        try {
            const formData = new FormData(searchForm);

            const response = await fetch('/search', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Search failed');
            }

            const data = await response.json();
            displayResults(data.results);

        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            loadingOverlay.classList.remove('active');
        }
    });

    // Check for findSimilar parameter on page load
    window.addEventListener('DOMContentLoaded', () => {
        // Restore search state if available
        restoreSearchState();

        const urlParams = new URLSearchParams(window.location.search);
        const findSimilarGuid = urlParams.get('findSimilar');

        if (findSimilarGuid) {
            // Clear URL parameter
            window.history.replaceState({}, '', '/');
            // Trigger find similar
            findSimilar(findSimilarGuid);
        }
    });

    function displayResults(results) {
        if (results.length === 0) {
            noResults.style.display = 'block';
            return;
        }
        
        resultsTitle.textContent = `${results.length} Result${results.length !== 1 ? 's' : ''}`;
        resultsGrid.innerHTML = '';
        
        results.forEach(photo => {
            const card = createPhotoCard(photo);
            resultsGrid.appendChild(card);
        });
        
        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    function createPhotoCard(photo) {
        const card = document.createElement('div');
        card.className = 'photo-card';
        
        let description = '';
        if (photo.description && photo.description.objects) {
            description = photo.description.objects.slice(0, 3).join(', ');
        }
        
        let location = '';
        if (photo.location && photo.location.city) {
            location = `${photo.location.city}, ${photo.location.state || photo.location.country || ''}`;
        }
        
        card.innerHTML = `
            <div style="position: relative;">
                <img src="${photo.thumbnail_url}" alt="${photo.file_name}" loading="lazy" onclick="window.location.href='/photo/${photo.guid}'">
                ${photo.score ? `<span class="score-badge">${(photo.score * 100).toFixed(0)}%</span>` : ''}
            </div>
            <div class="photo-card-body">
                <div class="photo-card-title">${photo.file_name}</div>
                ${photo.date_taken ? `<div class="photo-card-meta"><i class="bi bi-calendar"></i> ${formatDate(photo.date_taken)}</div>` : ''}
                ${location ? `<div class="photo-card-meta"><i class="bi bi-geo-alt"></i> ${location}</div>` : ''}
                ${description ? `<div class="photo-card-meta"><i class="bi bi-tag"></i> ${description}</div>` : ''}
                <button class="btn btn-sm btn-outline-primary mt-2 w-100" onclick="findSimilar('${photo.guid}', event)">
                    <i class="bi bi-images"></i> Find Similar
                </button>
            </div>
        `;
        
        return card;
    }

    async function findSimilar(guid, event) {
        // Stop event propagation so card click doesn't fire
        if (event) {
            event.stopPropagation();
        }
        
        // Show loading
        loadingOverlay.classList.add('active');
        
        try {
            const response = await fetch(`/similar/${guid}?limit=20`);
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to find similar photos');
            }
            
            const data = await response.json();
            displayResults(data.results);
            
            // Update title to indicate this is a similarity search
            resultsTitle.textContent = `${data.results.length} Similar Photo${data.results.length !== 1 ? 's' : ''}`;
            
        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            loadingOverlay.classList.remove('active');
        }
    }

    function formatDate(isoDate) {
        try {
            const date = new Date(isoDate);
            return date.toLocaleDateString();
        } catch {
            return isoDate.split('T')[0];
        }
    }

    function clearResults() {
        resultsSection.style.display = 'none';
        noResults.style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function clearSearch() {
        // Reset the form
        searchForm.reset();

        // Clear file inputs manually (reset doesn't always work for files)
        document.getElementById('queryImage').value = '';
        document.getElementById('hybridImage').value = '';

        // Clear results
        clearResults();

        // Clear saved search state
        sessionStorage.removeItem('searchState');

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function saveSearchState() {
        const state = {
            searchType: document.querySelector('input[name="search_type"]').value,
            textQuery: document.getElementById('textQuery').value,
            limit: document.getElementById('limit').value,
            locationCity: document.querySelector('input[name="location_city"]').value,
            locationState: document.querySelector('input[name="location_state"]').value,
            locationCountry: document.querySelector('input[name="location_country"]').value,
            dateFrom: document.querySelector('input[name="date_from"]').value,
            dateTo: document.querySelector('input[name="date_to"]').value,
            cameraMake: document.querySelector('input[name="camera_make"]').value,
            cameraModel: document.querySelector('input[name="camera_model"]').value,
            hybridText: document.getElementById('hybridText').value,
            activeTab: document.querySelector('.nav-link.active').id
        };
        sessionStorage.setItem('searchState', JSON.stringify(state));
    }

    function restoreSearchState() {
        const savedState = sessionStorage.getItem('searchState');
        if (!savedState) return;

        try {
            const state = JSON.parse(savedState);

            // Restore form values
            if (state.textQuery) document.getElementById('textQuery').value = state.textQuery;
            if (state.limit) document.getElementById('limit').value = state.limit;
            if (state.locationCity) document.querySelector('input[name="location_city"]').value = state.locationCity;
            if (state.locationState) document.querySelector('input[name="location_state"]').value = state.locationState;
            if (state.locationCountry) document.querySelector('input[name="location_country"]').value = state.locationCountry;
            if (state.dateFrom) document.querySelector('input[name="date_from"]').value = state.dateFrom;
            if (state.dateTo) document.querySelector('input[name="date_to"]').value = state.dateTo;
            if (state.cameraMake) document.querySelector('input[name="camera_make"]').value = state.cameraMake;
            if (state.cameraModel) document.querySelector('input[name="camera_model"]').value = state.cameraModel;
            if (state.hybridText) document.getElementById('hybridText').value = state.hybridText;

            // Restore active tab
            if (state.activeTab) {
                const tabButton = document.getElementById(state.activeTab);
                if (tabButton) {
                    tabButton.click();
                }
            }
        } catch (e) {
            console.error('Failed to restore search state:', e);
        }
    }

    // Initialize autocomplete on all text search fields
    document.addEventListener('DOMContentLoaded', () => {
        // Main text search field - searches across description fields
        const textQueryInput = document.getElementById('textQuery');
        if (textQueryInput) {
            new Autocomplete(textQueryInput, {
                fields: [
                    'description_parsed.objects',
                    'description_parsed.materials',
                    'description_parsed.setting',
                    'description_parsed.visual_attributes',
                    'user_keywords'
                ],
                minChars: 2,
                maxResults: 15
            });
        }

        // Hybrid text search field
        const hybridTextInput = document.getElementById('hybridText');
        if (hybridTextInput) {
            new Autocomplete(hybridTextInput, {
                fields: [
                    'description_parsed.objects',
                    'description_parsed.materials',
                    'description_parsed.setting',
                    'description_parsed.visual_attributes',
                    'user_keywords'
                ],
                minChars: 2,
                maxResults: 15
            });
        }

        // Location fields
        const locationCityInputs = document.querySelectorAll('input[name="location_city"]');
        locationCityInputs.forEach(input => {
            new Autocomplete(input, {
                fields: ['location.city'],
                minChars: 1,
                maxResults: 20
            });
        });

        const locationStateInputs = document.querySelectorAll('input[name="location_state"]');
        locationStateInputs.forEach(input => {
            new Autocomplete(input, {
                fields: ['location.state'],
                minChars: 1,
                maxResults: 20
            });
        });

        const locationCountryInputs = document.querySelectorAll('input[name="location_country"]');
        locationCountryInputs.forEach(input => {
            new Autocomplete(input, {
                fields: ['location.country'],
                minChars: 1,
                maxResults: 20
            });
        });

        // Camera fields
        const cameraMakeInputs = document.querySelectorAll('input[name="camera_make"]');
        cameraMakeInputs.forEach(input => {
            new Autocomplete(input, {
                fields: ['exif.camera_make'],
                minChars: 1,
                maxResults: 15
            });
        });

        const cameraModelInputs = document.querySelectorAll('input[name="camera_model"]');
        cameraModelInputs.forEach(input => {
            new Autocomplete(input, {
                fields: ['exif.camera_model'],
                minChars: 1,
                maxResults: 15
            });
        });
    });
</script>
{% endblock %}
